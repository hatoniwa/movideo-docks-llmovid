<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pharaoh’s Hyakunin Isshu Game — Reconstructed (EN)</title>
  <style>
    body {
      margin: 0;
      background: black;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
      font-family: 'Arial Black', sans-serif;
      color: white;
      user-select: none;
    }

    #game-container {
      position: relative;
      width: 640px;
      height: 460px;
      background: black;
      border: 2px solid #333;
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }

    .scene-element {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      display: none;
    }

    /* Dialogue / intro scene (fades in) */
    #dialogue-scene {
      background-image: url('scene99.jpg');
      background-size: cover;
      background-position: center;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      align-items: center;
      z-index: 20;
      opacity: 0;
      transition: opacity 3s ease-in;
    }

    #dialogue-box, #message-box {
      width: 80%;
      padding: 15px;
      margin-bottom: 20px;
      background-color: rgba(0, 0, 0, 0.7);
      border: 2px solid #00FFFF;
      border-radius: 10px;
      text-align: center;
      font-size: 1.5em;
      line-height: 1.4em;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
      z-index: 3;
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
    }

    /* 7x7 magic cover pieces */
    .piece {
      position: absolute;
      width: calc(100% / 7);
      height: calc(100% / 7);
      background-image: url('intro_cover_49.jpg');
      background-size: 700% 700%;
      opacity: 1;
      transition: transform 1s ease-out, opacity 1s ease-out;
    }

    .button-box {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: none;
      gap: 20px;
      z-index: 10;
    }

    .nav-button {
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      background-color: cyan;
      color: black;
      cursor: pointer;
    }

    #countdown {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 32px;
      display: block;
      z-index: 2;
    }

    /* 4 cover pieces (per scene) */
    .cover {
      position: absolute;
      width: 50%;
      height: 50%;
      cursor: pointer;
      z-index: 1;
    }

    #scene-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      position: absolute;
      z-index: -1;
    }

    /* Reward & Game Over overlays */
    #reward-area, #game-over-area {
      position: absolute;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 30;
      opacity: 0;
      transition: opacity 1s ease-in-out;
    }

    #reward-message, #game-over-message {
        font-size: 2em;
        margin-bottom: 20px;
        color: lime;
    }

    #reward-buttons {
      display: flex;
      gap: 20px;
      margin-top: 20px;
    }

    #reward-image-display {
        max-width: 90%;
        max-height: 70%;
        object-fit: contain;
        display: none;
        margin-top: 20px;
        border: 3px solid gold;
        box-shadow: 0 0 15px gold;
    }
  </style>
</head>
<body>
  <div id="game-container">
    <div id="dialogue-scene" class="scene-element">
      <div id="dialogue-box"></div>
    </div>

    <img id="scene-img" src="" alt="Scene">
    <div id="countdown"></div>
    <div id="message-box"></div>

    <div id="reward-area">
        <div id="reward-message"></div>
        <div id="reward-buttons">
            <button id="reward-A-btn" class="nav-button">A</button>
            <button id="reward-B-btn" class="nav-button">B</button>
            <button id="reward-C-btn" class="nav-button">C</button>
        </div>
        <img id="reward-image-display" src="" alt="Reward image">
        <div class="button-box" id="reward-final-buttons" style="margin-top: 40px;">
            <button id="back-to-2nd-from-reward-btn" class="nav-button">Back to Part II</button>
            <button id="end-game-from-reward-btn" class="nav-button">End Game</button>
        </div>
    </div>

    <div id="game-over-area">
        <div id="game-over-message"></div>
        <div class="button-box" id="game-over-buttons" style="margin-top: 40px;">
            <button id="retry-current-part-btn" class="nav-button"></button>
            <button id="exit-game-btn" class="nav-button">End Game</button>
        </div>
    </div>
  </div>

  <script>
    const gameContainer = document.getElementById('game-container');
    const dialogueScene = document.getElementById('dialogue-scene');
    const dialogueBox = document.getElementById('dialogue-box');
    const sceneImg = document.getElementById('scene-img');
    const countdown = document.getElementById('countdown');
    const messageBox = document.getElementById('message-box');

    const rewardArea = document.getElementById('reward-area');
    const rewardMessage = document.getElementById('reward-message');
    const rewardButtons = document.getElementById('reward-buttons');
    const rewardImageDisplay = document.getElementById('reward-image-display');
    const rewardBtnA = document.getElementById('reward-A-btn');
    const rewardBtnB = document.getElementById('reward-B-btn');
    const rewardBtnC = document.getElementById('reward-C-btn');
    const rewardFinalButtons = document.getElementById('reward-final-buttons');
    const backTo2ndFromRewardBtn = document.getElementById('back-to-2nd-from-reward-btn');
    const endGameFromRewardBtn = document.getElementById('end-game-from-reward-btn');

    const gameOverArea = document.getElementById('game-over-area');
    const gameOverMessage = document.getElementById('game-over-message');
    const gameOverButtons = document.getElementById('game-over-buttons');
    const retryCurrentPartBtn = document.getElementById('retry-current-part-btn');
    const exitGameBtn = document.getElementById('exit-game-btn');

    /* Intro guide messages */
    const introGuideMessages = [
      "In this game, each image is covered by 4 pieces.",
      "Tap the covers in sequence to remove all of them.",
      "Clear all covers to go to the next stage.",
      "Clear every stage and a special reward awaits you!"
    ];

    // Scene lists per part
    const practicePartScenes = ["scene99", "scene70", "scene72", "scene73"]; // Practice (after intro)
    const firstPartScenes    = ["scene99", "scene50", "scene51", "scene52"]; // Part I
    const secondPartScenes   = ["scene60", "scene61", "scene62", "scene63"]; // Part II
    const thirdPartScenes    = []; // Part III (not implemented here)

    // Game state
    let currentPart = 'intro'; // 'intro', 'practice', 'firstPart', 'secondPart', 'thirdPart'
    let currentPartSceneList = [];
    let currentPartStartIndex = 0;

    let currentIndex = 0;
    let clickSequence = [];

    let totalScore = 0; // used in Part II
    let playCount = 0;  // attempts within a part
    const MAX_PLAY_COUNT = 5;

    const rewardImages = {
        A: 'reward_a.jpg',
        B: 'reward_b.jpg',
        C: 'reward_c.jpg'
    };

    /* ----- Intro guide sequence ----- */
    function showIntroGuideSequence() {
      dialogueScene.style.display = 'flex';
      dialogueScene.style.opacity = 1;
      dialogueBox.style.opacity = 1;

      let index = 0;
      const interval = setInterval(() => {
        if (index < introGuideMessages.length) {
          dialogueBox.textContent = introGuideMessages[index++];
        } else {
          clearInterval(interval);
          dialogueBox.style.opacity = 0;
          dialogueScene.style.opacity = 0;
          setTimeout(() => {
            dialogueScene.style.display = 'none';
            startMagicPerformance();
          }, 1000);
        }
      }, 2000);
    }

    /* ----- Intro magic performance (7x7 pieces disperse) ----- */
    function startMagicPerformance() {
      clearGameContainer();

      const pot = document.createElement('img');
      pot.src = 'magic_pot.png';
      pot.alt = 'Magic pot';
      pot.style.position = 'absolute';
      pot.style.width = '100%';
      pot.style.height = '100%';
      pot.style.objectFit = 'cover';
      gameContainer.appendChild(pot);

      const totalRows = 7, totalCols = 7;
      for (let row = 0; row < totalRows; row++) {
        for (let col = 0; col < totalCols; col++) {
          const piece = document.createElement('div');
          piece.className = 'piece';
          piece.style.left = `${(100 / totalCols) * col}%`;
          piece.style.top = `${(100 / totalRows) * row}%`;
          piece.style.backgroundPosition = `${(-100 / 6) * col}% ${(-100 / 6) * row}%`;
          gameContainer.appendChild(piece);

          setTimeout(() => {
            piece.style.transform = `translate(${(Math.random() - 0.5) * 200}px, ${(Math.random() - 0.5) * 200}px)`;
            piece.style.opacity = 0;
          }, 100 + 20 * (row * totalCols + col));
        }
      }

      setTimeout(() => {
        showNavButtons();
      }, 3000);
    }

    /* ----- Navigation buttons (start practice) ----- */
    function showNavButtons() {
      const buttonBox = document.createElement('div');
      buttonBox.className = 'button-box';
      buttonBox.style.display = 'flex';

      const backBtn = document.createElement('button');
      backBtn.textContent = 'Back to Start';
      backBtn.className = 'nav-button';
      backBtn.onclick = () => location.reload();

      const nextBtn = document.createElement('button');
      nextBtn.textContent = 'Proceed to Game';
      nextBtn.className = 'nav-button';
      nextBtn.onclick = () => {
        buttonBox.style.display = 'none';
        clearGameContainer();
        // Start Practice part
        startPart('practice');
      };

      buttonBox.appendChild(backBtn);
      buttonBox.appendChild(nextBtn);
      gameContainer.appendChild(buttonBox);
    }

    /* ----- Start a part (practice / I / II / III) ----- */
    function startPart(partName) {
        currentPart = partName;
        currentIndex = 0;
        playCount = 0;

        if (partName === 'practice') {
            currentPartSceneList = practicePartScenes;
            currentPartStartIndex = 0;
            showMessage("[Practice]\nRemove all 4 covers. Any order is OK.", () => {
                startCountdown(loadCurrentScene);
            }, 3000);

        } else if (partName === 'firstPart') {
            currentPartSceneList = firstPartScenes;
            currentPartStartIndex = 0;
            showMessage("[Part I]\nRemove the 4 covers.\nThe 3rd stage has a required order.", () => {
                startCountdown(loadCurrentScene);
            }, 3000);

        } else if (partName === 'secondPart') {
            currentPartSceneList = secondPartScenes;
            currentPartStartIndex = 0;
            totalScore = 0;
            showMessage("[Part II]\nRemove the 4 covers and aim for a high score.\nThe 2nd and 3rd stages have required orders.", () => {
                startCountdown(loadCurrentScene);
            }, 4000);

        } else if (partName === 'thirdPart') {
            currentPartSceneList = thirdPartScenes;
            currentPartStartIndex = 0;
            showMessage("[Part III]\nFrom here it becomes a 3×3 puzzle!", () => {
                startCountdown(loadCurrentScene);
            }, 3000);
        }
    }

    /* ----- Countdown utility ----- */
    function startCountdown(callbackFunc, ...args) {
        countdown.innerText = "4";
        countdown.style.display = 'block';
        let count = 4;
        const timer = setInterval(() => {
            count--;
            if (count > 0) {
                countdown.innerText = count;
            } else {
                clearInterval(timer);
                countdown.style.display = 'none';
                callbackFunc(...args);
            }
        }, 1000);
    }

    /* ----- Load current scene in the current part ----- */
    function loadCurrentScene() {
        if (currentIndex < currentPartSceneList.length) {
            const sceneName = currentPartSceneList[currentIndex];
            sceneImg.src = `${sceneName}.jpg`;
            sceneImg.alt = `Scene ${sceneName}`;
            clickSequence = [];

            document.querySelectorAll('.cover').forEach(el => el.remove());

            for (let i = 1; i <= 4; i++) {
                const part = document.createElement('img');
                part.src = `${sceneName}_part${i}.jpg`;
                part.alt = `Cover ${i}`;
                part.className = 'cover';
                part.dataset.index = i;

                part.style.top = i <= 2 ? '0' : '50%';
                part.style.left = (i % 2 === 1) ? '0' : '50%';

                part.addEventListener('click', () => {
                    part.style.display = 'none';
                    clickSequence.push(i);
                    checkComplete(sceneName);
                });
                gameContainer.appendChild(part);
            }
        } else {
            handlePartCompletion();
        }
    }

    /* ----- Completion check (order rules by part/scene) ----- */
    function checkComplete(sceneName) {
      const remaining = document.querySelectorAll('.cover');
      const allHidden = [...remaining].every(c => c.style.display === 'none');

      if (allHidden) {
        let isCorrect = true;
        let correctOrder = [];

        // Order rules
        if (currentPart === 'firstPart' && sceneName === "scene51") {
            correctOrder = [3, 1, 4, 2];
        } else if (currentPart === 'secondPart') {
            if (sceneName === "scene61") {
                correctOrder = [2, 4, 1, 3];
            } else if (sceneName === "scene62") {
                correctOrder = [1, 3, 2, 4];
            }
        }

        if (correctOrder.length > 0) {
            isCorrect = clickSequence.length === correctOrder.length &&
                        correctOrder.every((val, idx) => val === clickSequence[idx]);
        }

        if (!isCorrect) {
            playCount++;
            showMessage(`Wrong order! Failed. ${MAX_PLAY_COUNT - playCount} tries left.`, () => {
                if (playCount >= MAX_PLAY_COUNT) {
                    showGameOver(`[${currentPart === 'firstPart' ? 'Part I' : 'Part II'}] Unfortunately, you could not clear within ${MAX_PLAY_COUNT} tries.`);
                } else {
                    resetCurrentScene();
                }
            });
            return;
        }

        // Scoring (Part II only)
        if (currentPart === 'secondPart') {
            totalScore += 100; // simple scoring
        }

        setTimeout(() => {
          currentIndex++;
          document.querySelectorAll('.cover').forEach(el => el.remove());
          loadCurrentScene();
        }, 500);
      }
    }

    /* ----- Reset current scene ----- */
    function resetCurrentScene() {
      document.querySelectorAll('.cover').forEach(el => el.remove());
      clickSequence = [];
      loadCurrentScene();
    }

    /* ----- Part completion flow ----- */
    function handlePartCompletion() {
        document.querySelectorAll('.cover').forEach(el => el.remove());

        if (currentPart === 'practice') {
            showMessage("Practice cleared! Next: [Part I].", () => {
                startPart('firstPart');
            }, 3000);

        } else if (currentPart === 'firstPart') {
            showMessage("Part I cleared! Now, [Part II].", () => {
                startPart('secondPart');
            }, 3000);

        } else if (currentPart === 'secondPart') {
            showMessage("Part II cleared! Final result!", () => {
                showFinalResult();
            }, 3000);

        } else if (currentPart === 'thirdPart') {
            showMessage("All games cleared! Congratulations!", () => {
                // final completion flow (not implemented)
            }, 3000);
        }
    }

    /* ----- Final result after Part II ----- */
    function showFinalResult() {
      clearGameContainer();
      sceneImg.src = "scene07.jpg";
      sceneImg.alt = "Final result";

      messageBox.style.opacity = 1;
      messageBox.style.display = 'block';

      const messages = [
        "Part II cleared! Congratulations!",
        `Final Score: ${totalScore}`
      ];

      let index = 0;
      const interval = setInterval(() => {
        if (index < messages.length) {
          messageBox.textContent = messages[index++];
        } else {
          clearInterval(interval);
          messageBox.style.opacity = 0;
          setTimeout(() => {
            messageBox.style.display = 'none';
            checkRewardAvailability();
          }, 500);
        }
      }, 2000);
    }

    /* ----- Reward availability by score ----- */
    function checkRewardAvailability() {
        if (totalScore >= 300) {
            startCountdown(showRewardSelection);
        } else {
            showMessage("So close! You didn’t reach the reward threshold.", () => {
                showFinalButtons('reward');
            });
        }
    }

    /* ----- Reward selection screen ----- */
    function showRewardSelection() {
        clearGameContainer();
        sceneImg.src = "scene07.jpg";
        sceneImg.alt = "Reward selection";

        rewardArea.style.display = 'flex';
        setTimeout(() => rewardArea.style.opacity = 1, 100);

        rewardMessage.textContent = "Pick your reward!";
        rewardButtons.style.display = 'flex';
        rewardImageDisplay.style.display = 'none';

        rewardBtnA.onclick = () => selectReward('A');
        rewardBtnB.onclick = () => selectReward('B');
        rewardBtnC.onclick = () => selectReward('C');

        rewardFinalButtons.style.display = 'none';
    }

    /* ----- Choose reward and show image ----- */
    function selectReward(choice) {
        rewardButtons.style.display = 'none';
        rewardMessage.textContent = `You chose “${choice}”!`;
        rewardImageDisplay.src = rewardImages[choice];
        rewardImageDisplay.alt = `Reward ${choice}`;
        rewardImageDisplay.style.display = 'block';

        setTimeout(() => {
            showFinalButtons('reward');
        }, 2000);
    }

    /* ----- Game Over screen ----- */
    function showGameOver(message) {
        clearGameContainer();
        sceneImg.src = "scene07.jpg";
        sceneImg.alt = "Game Over";

        gameOverArea.style.display = 'flex';
        setTimeout(() => gameOverArea.style.opacity = 1, 100);

        gameOverMessage.textContent = message;
        gameOverButtons.style.display = 'flex';

        retryCurrentPartBtn.textContent = `Retry ${currentPart === 'firstPart' ? 'Part I' : 'Part II'}`;
        retryCurrentPartBtn.onclick = () => {
            gameOverArea.style.display = 'none';
            clearGameContainer();
            startPart(currentPart);
        };
        exitGameBtn.onclick = () => {
            location.reload();
        };
    }

    /* ----- Final buttons (from Reward flow) ----- */
    function showFinalButtons(fromScreen) {
        if (fromScreen === 'reward') {
            rewardFinalButtons.style.display = 'flex';
            backTo2ndFromRewardBtn.onclick = () => {
                clearGameContainer();
                startPart('secondPart');
            };
            endGameFromRewardBtn.onclick = () => {
                location.reload();
            };
        } else {
            // not used currently
        }
    }

    /* ----- Message helper ----- */
    function showMessage(msg, callback = null, duration = 2000) {
        messageBox.textContent = msg;
        messageBox.style.opacity = 1;
        messageBox.style.display = 'block';
        setTimeout(() => {
            messageBox.style.opacity = 0;
            setTimeout(() => {
                messageBox.style.display = 'none';
                if (callback) callback();
            }, 500);
        }, duration);
    }

    /* ----- Remove dynamic children but keep core layers ----- */
    function clearGameContainer() {
      const preservedElements = [sceneImg, countdown, messageBox, dialogueScene, rewardArea, gameOverArea];
      gameContainer.innerHTML = '';

      preservedElements.forEach(el => {
        if (el && !gameContainer.contains(el)) {
          gameContainer.appendChild(el);
        }
      });
      rewardArea.style.display = 'none';
      rewardArea.style.opacity = 0;
      gameOverArea.style.display = 'none';
      gameOverArea.style.opacity = 0;
      dialogueScene.style.display = 'none';
    }

    /* ----- Entry point ----- */
    window.onload = () => {
      clearGameContainer();
      showIntroGuideSequence();
     window.location.href=' https://hatoniwa.github.io/movideo-aamovid/end-card.html .' 
    };
  </script>
</body>
</html>
